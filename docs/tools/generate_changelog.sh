#!/bin/bash

# DrowsyGuard æ›´æ”¹æ­·ç¨‹ç”Ÿæˆå·¥å…·
# ç”¨æ³•: ./generate_changelog.sh [åŠŸèƒ½åç¨±] [æè¿°]

set -e

# é¡è‰²å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ç²å–ç•¶å‰æ—¥æœŸå’Œæ™‚é–“
CURRENT_DATE=$(date +"%Y_%m_%d")
CURRENT_TIME=$(date +"%H%M")
CURRENT_DATETIME=$(date +"%Y-%m-%d")

# åŠŸèƒ½åç¨±å’Œæè¿°
FEATURE_NAME=$1
DESCRIPTION=$2

if [ -z "$FEATURE_NAME" ]; then
    echo -e "${RED}éŒ¯èª¤: è«‹æä¾›åŠŸèƒ½åç¨±${NC}"
    echo "ç”¨æ³•: $0 [åŠŸèƒ½åç¨±] [æè¿°]"
    echo "ç¤ºä¾‹: $0 'UI_COMPONENTS_REFACTOR' 'UI çµ„ä»¶é‡æ§‹'"
    exit 1
fi

if [ -z "$DESCRIPTION" ]; then
    echo -e "${YELLOW}è­¦å‘Š: æœªæä¾›æè¿°ï¼Œå°‡ä½¿ç”¨åŠŸèƒ½åç¨±ä½œç‚ºæè¿°${NC}"
    DESCRIPTION=$FEATURE_NAME
fi

# æª¢æŸ¥åŒä¸€å¤©æ˜¯å¦å·²æœ‰ä¿®æ”¹ï¼Œç”Ÿæˆåºåˆ—è™Ÿ
CHANGELOG_DIR="docs/changelog"
SEQUENCE_NUM=1

# æŸ¥æ‰¾ç•¶å¤©å·²æœ‰çš„æ›´æ”¹æ­·ç¨‹æ–‡ä»¶
for file in "$CHANGELOG_DIR"/CHANGELOG_*_"$CURRENT_DATE"*.md; do
    if [ -f "$file" ]; then
        # æå–åºåˆ—è™Ÿ
        filename=$(basename "$file")
        if [[ $filename =~ ${CURRENT_DATE}_([0-9]{3}) ]]; then
            existing_seq=${BASH_REMATCH[1]}
            if [ "$existing_seq" -ge "$SEQUENCE_NUM" ]; then
                SEQUENCE_NUM=$((existing_seq + 1))
            fi
        fi
    fi
done

# æ ¼å¼åŒ–åºåˆ—è™Ÿç‚º3ä½æ•¸
SEQUENCE_NUM_FORMATTED=$(printf "%03d" $SEQUENCE_NUM)

# ç”Ÿæˆæ–‡ä»¶å
FILENAME="CHANGELOG_${FEATURE_NAME}_${CURRENT_DATE}_${SEQUENCE_NUM_FORMATTED}.md"
FILEPATH="$CHANGELOG_DIR/$FILENAME"

echo -e "${BLUE}æ­£åœ¨ç”Ÿæˆæ›´æ”¹æ­·ç¨‹æ–‡æª”...${NC}"
echo -e "${GREEN}æ–‡ä»¶å: $FILENAME${NC}"
echo -e "${GREEN}åŠŸèƒ½åç¨±: $FEATURE_NAME${NC}"
echo -e "${GREEN}æè¿°: $DESCRIPTION${NC}"
echo -e "${GREEN}åºåˆ—è™Ÿ: $SEQUENCE_NUM_FORMATTED${NC}"

# å‰µå»ºæ–‡æª”å…§å®¹
cat > "$FILEPATH" << EOF
# æ›´æ”¹æ­·ç¨‹ - $DESCRIPTION - $CURRENT_DATETIME

---
title: "$DESCRIPTION æ›´æ”¹æ­·ç¨‹"
version: "v1.0.0"
created_date: "$CURRENT_DATETIME"
last_updated: "$CURRENT_DATETIME"
author: "DrowsyGuard é–‹ç™¼åœ˜éšŠ"
status: "active"
tags: ["åŠŸèƒ½", "æ›´æ–°"]
---

## ðŸŽ¯ æ›´æ”¹æ¦‚è¿°

æœ¬æ¬¡æ›´æ”¹å¯¦ç¾äº† $DESCRIPTION åŠŸèƒ½ã€‚

## âœ… å®Œæˆçš„åŠŸèƒ½

### ä¸»è¦åŠŸèƒ½ âœ…
- [ ] åŠŸèƒ½1
- [ ] åŠŸèƒ½2
- [ ] åŠŸèƒ½3

### æŠ€è¡“æ”¹é€² âœ…
- [ ] æ”¹é€²1
- [ ] æ”¹é€²2
- [ ] æ”¹é€²3

## ðŸ”§ æŠ€è¡“å¯¦ç¾

### 1. æž¶æ§‹è¨­è¨ˆ
æè¿°æž¶æ§‹è¨­è¨ˆæ€è·¯å’Œå¯¦ç¾æ–¹æ¡ˆ

### 2. æ ¸å¿ƒæŠ€è¡“
- æŠ€è¡“1: æè¿°
- æŠ€è¡“2: æè¿°
- æŠ€è¡“3: æè¿°

### 3. ä¾è³´ç®¡ç†
- æ–°å¢žä¾è³´: æè¿°
- æ›´æ–°ä¾è³´: æè¿°
- ç§»é™¤ä¾è³´: æè¿°

## ðŸ§ª æ¸¬è©¦çµæžœ

### ç·¨è­¯æ¸¬è©¦ âœ…
- [ ] æ¨¡çµ„ç·¨è­¯æˆåŠŸ
- [ ] ä¾è³´é—œä¿‚æ­£ç¢º
- [ ] ç„¡ç·¨è­¯éŒ¯èª¤

### åŠŸèƒ½æ¸¬è©¦ âœ…
- [ ] æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸
- [ ] é‚Šç•Œæƒ…æ³è™•ç†
- [ ] éŒ¯èª¤è™•ç†å®Œå–„

### æ€§èƒ½æ¸¬è©¦ âœ…
- [ ] éŸ¿æ‡‰æ™‚é–“é”æ¨™
- [ ] å…§å­˜ä½¿ç”¨å„ªåŒ–
- [ ] é›»æ± æ¶ˆè€—åˆç†

## ðŸ“Š æ€§èƒ½æŒ‡æ¨™

### åŠŸèƒ½æŒ‡æ¨™
| æŒ‡æ¨™ | å¯¦ç¾å‰ | å¯¦ç¾å¾Œ | æ”¹é€²å¹…åº¦ |
|------|--------|--------|----------|
| åŠŸèƒ½å®Œæ•´æ€§ | 0% | 100% | **å®Œå…¨å¯¦ç¾** |
| ç”¨æˆ¶é«”é©— | åŸºæº– | æå‡ | **é¡¯è‘—æ”¹å–„** |
| ç³»çµ±ç©©å®šæ€§ | åŸºæº– | æå‡ | **é¡¯è‘—æ”¹å–„** |

### æŠ€è¡“æŒ‡æ¨™
| æŒ‡æ¨™ | å¯¦ç¾å‰ | å¯¦ç¾å¾Œ | æ”¹é€²å¹…åº¦ |
|------|--------|--------|----------|
| ä»£ç¢¼è³ªé‡ | åŸºæº– | æå‡ | **é¡¯è‘—æ”¹å–„** |
| å¯ç¶­è­·æ€§ | åŸºæº– | æå‡ | **é¡¯è‘—æ”¹å–„** |
| å¯æ“´å±•æ€§ | åŸºæº– | æå‡ | **é¡¯è‘—æ”¹å–„** |

## ðŸ”„ ä¸‹ä¸€æ­¥è¨ˆåŠƒ

### çŸ­æœŸè¨ˆåŠƒ (1-2é€±)
1. **åŠŸèƒ½å®Œå–„**
   - è£œå……ç¼ºå¤±åŠŸèƒ½
   - å„ªåŒ–ç”¨æˆ¶é«”é©—
   - å®Œå–„éŒ¯èª¤è™•ç†

2. **æ¸¬è©¦è¦†è“‹**
   - å–®å…ƒæ¸¬è©¦
   - é›†æˆæ¸¬è©¦
   - ç”¨æˆ¶é©—æ”¶æ¸¬è©¦

### ä¸­æœŸè¨ˆåŠƒ (1å€‹æœˆ)
1. **æ€§èƒ½å„ªåŒ–**
   - éŸ¿æ‡‰é€Ÿåº¦å„ªåŒ–
   - å…§å­˜ä½¿ç”¨å„ªåŒ–
   - é›»æ± æ¶ˆè€—å„ªåŒ–

2. **åŠŸèƒ½æ“´å±•**
   - æ–°åŠŸèƒ½é–‹ç™¼
   - ç¾æœ‰åŠŸèƒ½å¢žå¼·
   - ç”¨æˆ¶åé¥‹æ•´åˆ

### é•·æœŸè¨ˆåŠƒ (3å€‹æœˆ)
1. **ç”Ÿæ…‹ç³»çµ±å»ºè¨­**
   - æ–‡æª”å®Œå–„
   - é–‹ç™¼è€…å·¥å…·
   - ç¤¾å€å»ºè¨­

## ðŸ“ å‚™è¨»

### é‡è¦æ±ºç­–
1. æ±ºç­–1: æè¿°å’ŒåŽŸå› 
2. æ±ºç­–2: æè¿°å’ŒåŽŸå› 
3. æ±ºç­–3: æè¿°å’ŒåŽŸå› 

### æŠ€è¡“å‚µå‹™
1. å‚µå‹™1: æè¿°å’Œå½±éŸ¿
2. å‚µå‹™2: æè¿°å’Œå½±éŸ¿
3. å‚µå‹™3: æè¿°å’Œå½±éŸ¿

### é¢¨éšªç·©è§£
1. é¢¨éšª1: æè¿°å’Œç·©è§£æŽªæ–½
2. é¢¨éšª2: æè¿°å’Œç·©è§£æŽªæ–½
3. é¢¨éšª3: æè¿°å’Œç·©è§£æŽªæ–½

## ðŸŽ‰ ç¸½çµ

æœ¬æ¬¡ $DESCRIPTION åŠŸèƒ½å¯¦ç¾æˆåŠŸé”æˆäº†é æœŸç›®æ¨™ï¼š

1. **åŠŸèƒ½å®Œæ•´æ€§** - æ‰€æœ‰è¨ˆåŠƒåŠŸèƒ½éƒ½å·²å¯¦ç¾
2. **æŠ€è¡“è³ªé‡** - ä»£ç¢¼è³ªé‡å’Œæž¶æ§‹è¨­è¨ˆç¬¦åˆæ¨™æº–
3. **ç”¨æˆ¶é«”é©—** - ç”¨æˆ¶é«”é©—å¾—åˆ°é¡¯è‘—æ”¹å–„
4. **ç³»çµ±ç©©å®šæ€§** - ç³»çµ±ç©©å®šæ€§å’Œæ€§èƒ½å¾—åˆ°æå‡

è©²åŠŸèƒ½çš„å¯¦ç¾ç‚ºé …ç›®çš„é•·æœŸç™¼å±•å¥ å®šäº†å …å¯¦çš„åŸºç¤Žã€‚

---

**ç‰ˆæœ¬**: v1.0.0  
**å‰µå»ºæ—¥æœŸ**: $CURRENT_DATETIME  
**ç‹€æ…‹**: active  
**ä¸‹ä¸€æ­¥**: å®Œå–„æ¸¬è©¦å’Œå„ªåŒ–
EOF

echo -e "${GREEN}âœ… æ›´æ”¹æ­·ç¨‹æ–‡æª”å·²æˆåŠŸå‰µå»º: $FILEPATH${NC}"

# æ›´æ–°ä¸»ç´¢å¼•æ–‡ä»¶
echo -e "${BLUE}æ­£åœ¨æ›´æ–°ä¸»ç´¢å¼•æ–‡ä»¶...${NC}"

# åœ¨ README.md ä¸­æ·»åŠ æ–°çš„æ›´æ”¹æ­·ç¨‹æ¢ç›®
README_FILE="docs/README.md"

# æª¢æŸ¥æ˜¯å¦éœ€è¦åœ¨ README ä¸­æ·»åŠ æ–°æ¢ç›®
if ! grep -q "$FILENAME" "$README_FILE"; then
    # æ‰¾åˆ°æ›´æ”¹æ­·ç¨‹è¡¨æ ¼çš„ä½ç½®ä¸¦æ·»åŠ æ–°æ¢ç›®
    sed -i.bak "/| \[CHANGELOG_.*\]/a\\
| [$FILENAME](./changelog/$FILENAME) | v1.0.0 | active | $DESCRIPTION |" "$README_FILE"
    echo -e "${GREEN}âœ… ä¸»ç´¢å¼•æ–‡ä»¶å·²æ›´æ–°${NC}"
else
    echo -e "${YELLOW}âš ï¸  ä¸»ç´¢å¼•æ–‡ä»¶ä¸­å·²å­˜åœ¨è©²æ¢ç›®${NC}"
fi

echo -e "${GREEN}ðŸŽ‰ æ›´æ”¹æ­·ç¨‹ç”Ÿæˆå®Œæˆï¼${NC}"
echo -e "${BLUE}ðŸ“ è«‹ç·¨è¼¯ $FILEPATH æ–‡ä»¶ï¼Œæ·»åŠ å…·é«”çš„å¯¦ç¾ç´°ç¯€${NC}" 